# 04 数据库安全性

不安全因素：

1. 非授权用户对数据库的恶意存取和破坏

2. 数据库中重要或敏感的数据被泄露

3. 安全环境的脆弱性

![](C:\Users\Polaris\AppData\Roaming\marktext\images\2023-06-11-16-19-06-image.png)

## 存取控制

组成：定义用户权限，并将用户权限登记到数据字典中

1. 用户对某一数据对象的操作权力称为权限

2. DBMS提供适当的语言来定义用户权限，存放在数据字典中，称做安全规则或授权规则

合法权限检查：

1. 用户发出存取数据库操作请求

2. DBMS查找数据字典，进行合法权限检查

## 自主存取控制

自主存取控制（Discretionary Access Control ，简称 DAC）。

数据库管理员：

1. 拥有所有对象的所有权限
2. 根据实际情况不同的权限授予不同的用户

用户：

1. 拥有自己建立的对象的全部的操作权限
2. 可以使用 GRANT，把权限授予其他用户

被授权的用户：

1. 如果具有“继续授权”的许可，可以把获得的权限再授予其他用户。

所有授予出去的权力在必要时又都可用 `REVOKE` 语句收回。

### GRANT

发出 `GRANT` 的用户：

1. 数据库管理员数据库对象创建者（即属主 Owner）
2. 拥有该权限的用户

接受权限的用户：

1. 一个或多个具体用户
2. `PUBLIC`（即全体用户）

![关系数据库系统中的存取权限](https://eaglebear2002.github.io/2022Spring-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA-04-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E6%80%A7/image-20220614204722386.png)

关系数据库系统中的存取权限

```sql
# GRANT 语句的一般格式：
# WITH GRANT OPTION 子句：可以再授予其他用户，不允许循环授权
GRANT <权限>[,<权限>]... ON <对象类型> <对象名>[,<对象类型> <对象名>]… TO <用户>[,<用户>]...
[WITH GRANT OPTION ];

# [例 4.1] 把查询 Student 表权限授给用户 U1
GRANT SELECT ON TABLE Student
    TO U1;

# [例 4.2] 把对 Student 表和 Course 表的全部权限授予用户 U2 和 U3
GRANT ALL PRIVILIGES ON TABLE Student,Course
TO U2,U3;

# [例 4.3] 把对表 SC 的查询权限授予所有用户
GRANT SELECT ON TABLE SC
    TO PUBLIC;

# [例 4.4] 把查询 Student 表和修改学生学号的权限授给用户 U4
GRANT UPDATE (Sno), SELECT ON TABLE Student
    TO U4;

# [例 4.5] 把对表 SC 的 INSERT 权限授予 U5 用户，并允许他再将此权限授予其他用户
GRANT INSERT ON TABLE SC TO U5
    WITH GRANT OPTION;

# [例 4.6]
GRANT INSERT ON TABLE SC TO U6
    WITH GRANT OPTION;

# [例 4.7]同样，U6 还可以将此权限授予 U7，但 U7 不能再传播此权限。
GRANT INSERT ON TABLE SC
    TO U7;
```

![执行例 4.1~4.7 后用户权限定义](https://eaglebear2002.github.io/2022Spring-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA-04-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E6%80%A7/image-20220614205657112.png)

执行例 4.1~4.7 后用户权限定义

### REVOKE

```sql
# REVOKE 语句的一般格式为：
REVOKE <权限>[,<权限>]... ON <对象类型> <对象名>[,<对象类型><对象名>]...
FROM <用户>[,<用户>]...[CASCADE | RESTRICT];

# [例 4.8] 把用户 U4 修改学生学号的权限收回
REVOKE UPDATE (Sno) ON TABLE Student
FROM U4;

# [例 4.9] 收回所有用户对表 SC 的查询权限
REVOKE SELECT ON TABLE SC
FROM PUBLIC;

# [例 4.10] 把用户 U5 对 SC 表的 INSERT 权限收回
# 将用户 U5 的 INSERT 权限收回的时候使用 CASCADE，则同时收回 U6 或 U7 的 INSERT 权限，否则拒绝执行该语句
# 如果 U6 或 U7 还从其他用户处获得对 SC 表的 INSERT 权限，则他们仍具有此权限，系统只收回直接或间接从 U5 处获得的权限
REVOKE INSERT ON TABLE SC
FROM U5 CASCADE;
```

![执行例 4.8~4.10 后用户权限定义](https://eaglebear2002.github.io/2022Spring-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA-04-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E6%80%A7/image-20220614210030873.png)

执行例 4.8~4.10 后用户权限定义

### 创建数据库模式的权限

```SQL
# 该命令不是 SQL 标准
CREATE USER <username> [WITH][DBA | RESOURCE | CONNECT];
```

只有系统的超级用户才有权创建一个新的数据库用户。

1. `CONNECT` 权限：如没有指定创建的新用户的权限，默认该用户拥有该权限。不能创建新用户， 不能创建模式，也不能创建基本表，只能登录数据库。
2. `RESOURCE` 权限：能创建基本表和视图，成为所创建对象的属主。但不能创建模式，不能创建新的用户。
3. `DBA` 权限：是系统中的超级用户，可以创建新的用户、创建模式、创建基本表和视图等；DBA 拥有对所有数据库对象的存取权限，还可以把这些权限授予一般用户。

![权限与可执行的操作对照表](https://eaglebear2002.github.io/2022Spring-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA-04-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E6%80%A7/image-20220614210815480.png)

### 数据库角色

数据库角色：被命名的一组与数据库操作相关的权限，角色是权限的集合，可以为一组具有相同权限的用户创建一个角色简化授权的过程。

```sql
# 角色的创建
CREATE ROLE <角色名>;
# 给角色授权
GRANT <权限>[,<权限>]... ON <对象类型>对象名 TO <角色>[,<角色>]...;

# 将一个角色授予其他的角色或用户
# 该语句把角色授予某用户，或授予另一个角色
# 授予者是角色的创建者或拥有在这个角色上的 ADMIN OPTION
# 指定了 WITH ADMIN OPTION 则获得某种权限的角色或用户还可以把这种权限授予其他角色
GRANT <角色 1>[,<角色 2>]… TO <角色或用户>[,<角色或用户>]... [WITH ADMIN OPTION];

# 角色权限的收回
# 用户可以回收角色的权限，从而修改角色拥有的权限
# REVOKE 执行者是角色的创建者或拥有在这个（些）角色上的 ADMIN OPTION
REVOKE <权限>[,<权限>]... ON <对象类型> <对象名> FROM <角色>[,<角色>]...;

# [例 4.11] 通过角色来实现将一组权限授予一个用户。
CREATE ROLE R1;
GRANT SELECT, UPDATE, INSERT ON TABLE Student
    TO R1;
GRANT R1 TO 王平,张明,赵玲;
REVOKE R1 FROM 王平;

# [例 4.12] 角色的权限修改
GRANT DELETE ON TABLE Student
TO R1;

# [例 4.13] 使 R1 减少了 SELECT 权限
REVOKE SELECT ON TABLE Student
FROM R1;
```

### 自主存取控制缺点

**数据的“无意泄露”**

原因：这种机制仅仅通过对数据的存取权限来进行安全控制，而数据本身并无安全性标记

解决：对系统控制下的所有主客体实施强制存取控制策略

## 强制存取控制

强制存取控制（Mandatory Access Control，简称 MAC）

1. 每一个数据对象被标以一定的密级
2. 每一个用户也被授予某一个级别的许可证
3. 对于任意一个对象，只有具有合法许可证的用户才可以存取

主体的敏感度标记称为许可证级别（Clearance Level），客体的敏感度标记称为密级（Classification Level）。

敏感度标记：   绝密（Top Secret，TS）>=机密（Secret，S）>=可信（Confidential，C）>=公开（Public，P）

强制存取控制规则：

1. 仅当主体的许可证级别大于或等于客体的密级时， 该主体才能读取相应的客体
2. 仅当主体的许可证级别小于或等于客体的密级时，该主体才能写相应的客体

> 规则 2 是防止把数据的密级从高流向低。如许可证级别为 TS 的主体读取密级为 TS 的客体并以密级 P 写回，造成数据泄露。在规则 2 下，用户可以把写入的对象赋予高于自己许可证级别的密级，一旦数据被写入，该用户自己也不能读取该数据了。
> 
> 规则 2 应该理解为：主体写入的客体内容**可以被赋予高于主体许可证级别的密级**，而不是：主体可以修改密级高于该主体许可证级别的客体。

## DAC+MAC 安全检查

原因：较高安全性级别提供的安全保护要包含较低级别的所有保护

l先进行自主存取控制检查，通过自主存取控制检查的数据对象再由系统进行强制存取控制检查，只有通过强制存取控制检查的数据对象方可存取。

![安全检查示意图](https://eaglebear2002.github.io/2022Spring-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA-04-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E6%80%A7/image-20220615091728509.png)

## 视图机制

把要保密的数据对无权存取这些数据的用户隐藏起来，对数据提供一定程度安全保护。间接地实现支持存取谓词的用户权限定义。

```sql
#  [例4.14] 建立计算机系学生的视图，把对该视图的SELECT权限授于王平，把该视图上的所有操作权限授于张明 
# 先建立计算机系学生的视图CS_Student
CREATE VIEW CS_Student
AS 
SELECT  *
FROM   Student
WHERE  Sdept='CS';

# 在视图上进一步定义存取权限
GRANT  SELECT
ON  CS_Student  
TO 王平;

GRANT ALL PRIVILIGES
ON  CS_Student  
TO  张明;
```

## 审计

启用一个专用的审计日志（Audit Log）将用户对数据库的所有操作记录在上面

审计员利用审计日志监控数据库中的各种行为，找出非法存取数据的人、时间和内容

C2以上安全级别的DBMS必须具有审计功能

**可选性:**

1. 很费时间和空间

2. DBA可以根据应用对安全性的要求，灵活地打开或关闭审计功能

3. 审计功能主要用于安全性要求较高的部门

**审计事件：**

1. 服务器事件：审计数据库服务器发生的事件

2. 系统权限：对系统拥有的结构或模式对象进行操作的审计,要求该操作的权限是通过系统权限获得的

3. 语句事件：对SQL语句，如DDL、DML、DQL及DCL语句的审计

4. 模式对象事件：对特定模式对象上进行的SELECT或DML操作的审计

**审计级别**

用户级审计：

1. 任何用户可设置的审计

2. 主要是用户针对自己创建的数据库表和视图进行审计

系统级审计：

1. 只能由数据库管理员设置

2. 监测成功或失败的登录要求、监测授权和收回操作以及其他数据库级权限下的操作

```sql
# AUDIT：设置审计 
# NOAUDIT：取消审计
# [例4.15] 对修改SC表结构或修改SC表数据的操作进行审计
AUDIT ALTER,UPDATE  
ON  SC;
# [例4.16] 取消对SC表的一切审计
NOAUDIT  ALTER,UPDATE  
ON  SC;
```

## 数据加密

方法:

1. 存储加密
   
   1. 透明存储加密：内核级加密保护方式，对用户完全透明。将数据在写到磁盘时对数据进行加密，授权用户读取数据时再对其进行解密。数据库的应用程序不需要做任何修改，只需在创建表语句中说明需加密的字段。
      
      内核级加密方法: 性能较好，安全完备性较高
   
   2. 非透明存储加密：通过多个加密函数实现

2. 传输加密
   
   1. 链路加密
      
      1. 在链路层进行加密
      
      2. 传输信息由报头和报文两部分组成
      
      3. 报文和报头均加密
   
   2. 端到端加密
      
      1. 在发送端加密，接收端解密
      
      2. 只加密报文不加密报头
      
      3. 所需密码设备数量相对较少，容易被非法监听者发现并从中获取敏感信息

## 其他安全性保护

推理控制：避免用户利用能够访问的数据推知更高密级的数据

隐蔽信道：间接数据传递

数据隐私保护：

1. 描述个人控制其不愿他人知道或他人不便知道的个人数据的能力

2. 范围很广：数据收集、数据存储、数据处理和数据发布等各个阶段
